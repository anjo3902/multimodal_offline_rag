<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Multimodal RAG System - NTRO</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2em;
    }
    .subtitle {
      text-align: center;
      color: #7f8c8d;
      margin-bottom: 30px;
      font-size: 0.9em;
    }
    .box { 
      border: 2px solid #e0e0e0; 
      padding: 20px; 
      border-radius: 10px; 
      margin-bottom: 25px;
      background: #fafafa;
    }
    .box h3 {
      margin-top: 0;
      color: #34495e;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    textarea { 
      width: 100%; 
      height: 100px;
      border: 2px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    input[type="file"] { 
      display: block; 
      margin: 12px 0;
      padding: 10px;
      border: 2px dashed #ddd;
      border-radius: 6px;
      width: 100%;
      cursor: pointer;
    }
    input[type="file"]:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    button { 
      padding: 12px 24px; 
      border-radius: 6px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      border: none; 
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .stats-bar {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .stat-card {
      flex: 1;
      min-width: 150px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    .stat-label {
      color: #7f8c8d;
      font-size: 0.85em;
      margin-top: 5px;
    }
    .answer-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      line-height: 1.8;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .answer-box h2 {
      color: #2c3e50;
      font-size: 1.3em;
      margin-top: 20px;
      margin-bottom: 10px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 5px;
    }
    .answer-box h2:first-child {
      margin-top: 0;
    }
    .answer-box ul, .answer-box ol {
      margin: 10px 0;
      padding-left: 25px;
    }
    .answer-box li {
      margin: 8px 0;
      line-height: 1.6;
    }
    .answer-box p {
      margin: 12px 0;
      line-height: 1.8;
    }
    .answer-box strong {
      color: #2c3e50;
      font-weight: 600;
    }
    .answer-box code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    .source-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      transition: all 0.3s;
      cursor: pointer;
    }
    .source-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #667eea;
    }
    .source-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .citation-badge {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.85em;
    }
    .file-icon {
      font-size: 1.5em;
    }
    .source-filename {
      font-weight: 600;
      color: #2c3e50;
      flex: 1;
    }
    .similarity-badge {
      background: #27ae60;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75em;
    }
    .source-content {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 0.9em;
      line-height: 1.5;
      max-height: 100px;
      overflow-y: auto;
      color: #555;
    }
    .source-meta {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 10px;
      font-size: 0.85em;
      color: #7f8c8d;
    }
    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .view-source-btn {
      background: #3498db;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.85em;
      display: inline-block;
      margin-top: 8px;
    }
    .view-source-btn:hover {
      background: #2980b9;
    }
    .loading {
      text-align: center;
      padding: 30px;
      color: #7f8c8d;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .upload-result {
      margin-top: 15px;
      padding: 12px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 6px;
      color: #155724;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #95a5a6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Multimodal RAG System</h1>
    <div class="subtitle">Offline Retrieval-Augmented Generation | NTRO</div>

    <!-- Statistics Bar -->
    <div class="stats-bar" id="statsBar" style="display:none;">
      <div class="stat-card">
        <div class="stat-number" id="totalChunks">0</div>
        <div class="stat-label">Total Chunks</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalDocs">0</div>
        <div class="stat-label">Documents</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalImages">0</div>
        <div class="stat-label">Images</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalAudio">0</div>
        <div class="stat-label">Audio Files</div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="box">
      <h3>üìÅ Upload & Index Files</h3>
      <p style="color:#7f8c8d; font-size:0.9em; margin-bottom:15px;">
        Supports: PDF, DOCX, TXT, Images (PNG, JPG), Audio (MP3, WAV, M4A, FLAC)
      </p>
      <input id="files" type="file" multiple accept=".pdf,.docx,.txt,.png,.jpg,.jpeg,.bmp,.mp3,.wav,.m4a,.flac" />
      <button onclick="upload()" id="uploadBtn">üì§ Upload & Index</button>
      <div id="uploadResult"></div>
    </div>

    <!-- Query Section -->
    <div class="box">
      <h3>üí¨ Ask Questions</h3>
      <p style="color:#7f8c8d; font-size:0.9em; margin-bottom:15px;">
        Choose your search mode: Text, Image, or Audio query
      </p>
      
      <!-- Search Mode Selector -->
      <div style="margin-bottom: 20px;">
        <label style="font-weight:600; color:#34495e; display:block; margin-bottom:8px;">üéØ Search Mode</label>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
          <button onclick="switchMode('text')" id="modeText" style="flex:1; background:#667eea;">üìù Text Query</button>
          <button onclick="switchMode('image')" id="modeImage" style="flex:1; background:#95a5a6;">üñºÔ∏è Image Query</button>
          <button onclick="switchMode('audio')" id="modeAudio" style="flex:1; background:#95a5a6;">üéµ Audio Query</button>
        </div>
      </div>
      
      <!-- Text Query -->
      <div id="textQuerySection" style="margin-bottom: 20px;">
        <label style="font-weight:600; color:#34495e; display:block; margin-bottom:8px;">üî§ Enter Your Question</label>
        <textarea id="query" placeholder="Type your question here, e.g., 'Explain metafac framework' or 'What are the ingredients for one pan chicken?'"></textarea>
        <button onclick="ask()" id="askBtn" style="margin-top:10px;">üîç Search & Answer</button>
      </div>
      
      <!-- Image Query -->
      <div id="imageQuerySection" style="display:none; border-top: 2px dashed #ddd; padding-top: 20px;">
        <label style="font-weight:600; color:#34495e; display:block; margin-bottom:8px;">üñºÔ∏è Upload Query Image</label>
        <p style="color:#7f8c8d; font-size:0.85em; margin-bottom:10px;">
          Upload an image or screenshot - the system will find similar images and related content
        </p>
        <input id="queryImage" type="file" accept=".png,.jpg,.jpeg,.bmp" style="border-style:solid;" />
        <button onclick="askByImage()" id="askImageBtn" style="margin-top:10px;">üîç Search by Image</button>
      </div>
      
      <!-- Audio Query -->
      <div id="audioQuerySection" style="display:none; border-top: 2px dashed #ddd; padding-top: 20px;">
        <!-- Voice Recording Option -->
        <div style="border: 2px solid #e8f4f8; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f0f8ff;">
          <label style="font-weight:600; color:#2980b9; display:block; margin-bottom:8px;">ÔøΩ Voice Recording Option</label>
          <p style="color:#7f8c8d; font-size:0.85em; margin-bottom:10px;">
            Record your voice directly - faster than uploading! (Uses browser's speech recognition)
          </p>
          <button onclick="toggleVoiceRecording()" id="voiceRecordBtn" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); margin-bottom: 10px;">
            üé§ Start Voice Recording
          </button>
          <span id="voiceStatus" style="margin-left: 10px; font-weight: 600; color: #7f8c8d;">Status: Ready</span>
          <div id="voiceTranscriptDisplay" style="margin-top:10px; padding:10px; background:#fff; border:1px solid #ddd; border-radius:5px; min-height:40px; display:none;">
            <strong>Transcribed Text:</strong>
            <div id="voiceTranscriptText" style="margin-top:5px; color:#2c3e50;"></div>
          </div>
        </div>
        
        <div style="text-align:center; color:#95a5a6; font-weight:600; margin:15px 0;">OR</div>
        
        <!-- File Upload Option -->
        <div style="border: 2px solid #f0e8f4; border-radius: 8px; padding: 15px; background: #faf5ff;">
          <label style="font-weight:600; color:#8e44ad; display:block; margin-bottom:8px;">üìÅ Upload Audio File</label>
          <p style="color:#7f8c8d; font-size:0.85em; margin-bottom:10px;">
            Upload an audio file - it will be transcribed on server and used to search for similar content
          </p>
          <input id="queryAudio" type="file" accept=".mp3,.wav,.m4a,.flac" style="border-style:solid;" />
        </div>
        
        <button onclick="askByAudio()" id="askAudioBtn" style="margin-top:15px; width:100%;">üîç Search by Audio</button>
      </div>
      
      <div id="resultsContainer" style="display:none;">
        <h4 style="margin-top:25px; color:#2c3e50;">üìù Answer</h4>
        <div class="answer-box" id="answer"></div>
        
        <h4 style="color:#2c3e50;">üìö Sources & Citations</h4>
        <div id="sources"></div>
      </div>
    </div>
  </div>

  <script>
    // Load stats on page load
    window.addEventListener('load', loadStats);

    async function loadStats() {
      try {
        const res = await fetch('/stats/');
        const data = await res.json();
        if (data.total_chunks > 0) {
          document.getElementById('statsBar').style.display = 'flex';
          document.getElementById('totalChunks').textContent = data.total_chunks;
          document.getElementById('totalDocs').textContent = data.by_type.document || 0;
          document.getElementById('totalImages').textContent = data.by_type.image || 0;
          document.getElementById('totalAudio').textContent = data.by_type.audio || 0;
        }
      } catch(e) {
        console.log('Stats not available yet');
      }
    }

    async function upload(){
      const inp = document.getElementById('files');
      const files = inp.files;
      if(files.length === 0){ 
        alert("Please select files to upload"); 
        return; 
      }
      
      const btn = document.getElementById('uploadBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Uploading & Indexing...';
      
      const fd = new FormData();
      for(let i=0; i<files.length; i++) fd.append('files', files[i]);
      
      try {
        const res = await fetch('/upload/', {method:'POST', body: fd});
        
        // Check if response is OK
        if (!res.ok) {
          const text = await res.text();
          let errorMsg = `Server error: ${res.status}`;
          try {
            const json = JSON.parse(text);
            errorMsg = json.error || json.message || errorMsg;
          } catch {
            // If not JSON, show first 100 chars of response
            errorMsg = text.substring(0, 100);
          }
          throw new Error(errorMsg);
        }
        
        const j = await res.json();
        
        // Check for error in response
        if (j.error) {
          throw new Error(j.error);
        }
        
        // Build result message with OCR details
        let resultHTML = `
          <div class="upload-result">
            ‚úÖ ${j.message || `Successfully uploaded and indexed ${files.length} file(s)!`}
          </div>
        `;
        
        // Show OCR extracted text if available
        if (j.details && j.details.length > 0) {
          for (const detail of j.details) {
            // Display IMAGE OCR text
            if (detail.type === 'image' && detail.ocr_text) {
              resultHTML += `
                <div style="margin-top: 15px; padding: 15px; background: #f0f4ff; border-left: 4px solid #667eea; border-radius: 6px;">
                  <div style="font-weight: bold; color: #667eea; margin-bottom: 8px;">
                    ÔøΩÔ∏è Extracted Text from "${detail.filename}" (${detail.ocr_char_count} characters using ${detail.ocr_backend})
                  </div>
                  <div style="background: white; padding: 12px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
${detail.ocr_text}
                  </div>
                  <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    ‚úÖ Visual embedding created | ‚úÖ ${detail.text_chunks || 0} text chunks indexed
                  </div>
                </div>
              `;
            }
            // Display AUDIO transcription
            else if (detail.type === 'audio' && detail.transcribed_text) {
              resultHTML += `
                <div style="margin-top: 15px; padding: 15px; background: #fff4e6; border-left: 4px solid #ff9800; border-radius: 6px;">
                  <div style="font-weight: bold; color: #ff9800; margin-bottom: 8px;">
                    üéµ Transcribed Audio "${detail.filename}" (${detail.char_count} characters, ${detail.duration_seconds}s)
                  </div>
                  <div style="background: white; padding: 12px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
${detail.transcribed_text}
                  </div>
                  <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    ‚úÖ ${detail.chunks} audio chunks indexed | ‚úÖ ~${detail.word_count} words
                  </div>
                </div>
              `;
            }
            // Display DOCUMENT text
            else if (detail.type === 'document' && detail.extracted_text) {
              resultHTML += `
                <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 6px;">
                  <div style="font-weight: bold; color: #4caf50; margin-bottom: 8px;">
                    üìÑ Extracted Text from ${detail.doc_type} "${detail.filename}" (${detail.char_count} characters)
                  </div>
                  <div style="background: white; padding: 12px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
${detail.extracted_text}
                  </div>
                  <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    ‚úÖ ${detail.chunks} text chunks indexed | ‚úÖ ~${detail.word_count} words
                  </div>
                </div>
              `;
            }
          }
        }
        
        document.getElementById('uploadResult').innerHTML = resultHTML;
        inp.value = '';
        loadStats(); // Refresh stats
      } catch(e) {
        console.error('Upload error:', e);
        document.getElementById('uploadResult').innerHTML = `
          <div style="background:#f8d7da; border-color:#f5c6cb; color:#721c24; padding:12px; border-radius:6px;">
            ‚ùå Error: ${e.message}
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üì§ Upload & Index';
      }
    }

    function getFileIcon(type) {
      const icons = {
        'document': 'üìÑ',
        'image': 'üñºÔ∏è',
        'audio': 'üéµ',
        'unknown': 'üìé'
      };
      return icons[type] || icons['unknown'];
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function markdownToHTML(text) {
      if (!text) return '';
      
      // Convert markdown to HTML for better rendering
      let html = text;
      
      // Headers (## Header -> <h2>Header</h2>)
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      
      // Bold (**text** -> <strong>text</strong>)
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      
      // Bullet points (- item -> <li>item</li>)
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      
      // Wrap consecutive <li> in <ul>
      html = html.replace(/(<li>.*?<\/li>\s*)+/gs, function(match) {
        return '<ul>' + match + '</ul>';
      });
      
      // Numbered lists (1. item -> <li>item</li>)
      html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
      
      // Wrap consecutive numbered <li> in <ol>
      html = html.replace(/(<li>.*?<\/li>\s*)+/gs, function(match) {
        // Only wrap if not already wrapped
        if (!match.startsWith('<ul>') && !match.startsWith('<ol>')) {
          return '<ol>' + match + '</ol>';
        }
        return match;
      });
      
      // Line breaks (double newline -> paragraph)
      html = html.replace(/\n\n+/g, '</p><p>');
      html = '<p>' + html + '</p>';
      
      // Clean up empty paragraphs
      html = html.replace(/<p>\s*<\/p>/g, '');
      html = html.replace(/<p>\s*(<[huo])/g, '$1');
      html = html.replace(/(<\/[huo][^>]*>)\s*<\/p>/g, '$1');
      
      return html;
    }

    async function ask(){
      const q = document.getElementById('query').value.trim();
      if(!q){ 
        alert("Please type a question"); 
        return; 
      }
      
      const btn = document.getElementById('askBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Searching & Generating...';
      
      document.getElementById('resultsContainer').style.display = 'block';
      document.getElementById('answer').innerHTML = '<div class="loading"><div class="spinner"></div>Generating answer...</div>';
      document.getElementById('sources').innerHTML = '<div class="loading">Loading sources...</div>';
      
      try {
        const fd = new FormData();
        fd.append('query', q);
        const res = await fetch('/query/', {method:'POST', body: fd});
        
        if (!res.ok) {
          throw new Error(`Server returned ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        if (!data) {
          throw new Error('No data received from server');
        }
        
        displayResults(data);
        
      } catch(e) {
        console.error("Error during query:", e);
        document.getElementById('answer').innerHTML = `<div style="color:#e74c3c;">‚ùå Error: ${e.message}</div>`;
        document.getElementById('sources').innerHTML = '';
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Search & Answer';
      }
    }

    async function askByImage(){
      const inp = document.getElementById('queryImage');
      const file = inp.files[0];
      if(!file){ 
        alert("Please select an image to query"); 
        return; 
      }
      
      const btn = document.getElementById('askImageBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Processing Image...';
      
      document.getElementById('resultsContainer').style.display = 'block';
      document.getElementById('answer').innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing image and generating answer...</div>';
      document.getElementById('sources').innerHTML = '<div class="loading">Loading sources...</div>';
      
      try {
        const fd = new FormData();
        fd.append('image', file);
        const res = await fetch('/query_by_image/', {method:'POST', body: fd});
        const data = await res.json();
        
        // Show OCR text if available
        if (data.ocr_text) {
          document.getElementById('answer').innerHTML = `
            <div style="background:#e8f4f8; padding:10px; border-radius:6px; margin-bottom:15px; border-left:4px solid #3498db;">
              <strong>üîç Text detected in image:</strong><br/>
              <em style="color:#555;">${data.ocr_text}</em>
            </div>
          ` + '<div class="answer-box">' + data.answer + '</div>';
        } else {
          displayResults(data);
        }
        
        displaySources(data.sources);
        inp.value = ''; // Clear file input
        
      } catch(e) {
        document.getElementById('answer').innerHTML = `<div style="color:#e74c3c;">‚ùå Error: ${e.message}</div>`;
        document.getElementById('sources').innerHTML = '';
        console.error("Error during image query:", e);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Search by Image';
      }
    }

    function displayResults(data) {
      // Convert markdown answer to HTML for better rendering
      let formattedAnswer = markdownToHTML(data.answer || "No answer generated");
      
      // Make citations clickable - link [1], [2], [3] to source cards
      formattedAnswer = formattedAnswer.replace(/\[(\d+)\]/g, (match, num) => {
        return `<span class="citation-link" onclick="scrollToSource(${num})" title="Click to view source ${num}">${match}</span>`;
      });
      
      // Add confidence score banner if available
      let confidenceBanner = '';
      if (data.confidence) {
        const conf = data.confidence;
        let confColor = conf.score >= 80 ? '#27ae60' : conf.score >= 60 ? '#f39c12' : '#e74c3c';
        let confIcon = conf.score >= 80 ? '‚úÖ' : conf.score >= 60 ? '‚ö†Ô∏è' : '‚ùå';
        
        confidenceBanner = `
          <div style="background: ${confColor}; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">${confIcon}</span>
            <div style="flex: 1;">
              <strong>Answer Confidence: ${conf.level} (${conf.score}%)</strong>
              <div style="font-size: 0.85em; opacity: 0.9; margin-top: 3px;">
                ${conf.citation_count} citations ‚Ä¢ ${conf.avg_source_quality}% avg source quality
              </div>
            </div>
          </div>
        `;
      }
      
      document.getElementById('answer').innerHTML = confidenceBanner + formattedAnswer;
      displaySources(data.sources);
    }

    function displaySources(sources) {
      const sourcesHtml = sources && sources.length > 0 
        ? sources.map(src => {
            const icon = getFileIcon(src.file_type);
            const similarity = (src.similarity_score * 100).toFixed(1);
            
            // Relevance indicator based on score
            let relevanceLabel = '';
            let relevanceColor = '';
            if (similarity >= 80) {
              relevanceLabel = 'üü¢ Excellent';
              relevanceColor = '#27ae60';
            } else if (similarity >= 60) {
              relevanceLabel = 'üü° Good';
              relevanceColor = '#f39c12';
            } else if (similarity >= 40) {
              relevanceLabel = 'üü† Fair';
              relevanceColor = '#e67e22';
            } else {
              relevanceLabel = 'üî¥ Low';
              relevanceColor = '#e74c3c';
            }
            
            let metaInfo = '';
            if (src.file_type === 'audio') {
              metaInfo = `
                <div class="meta-item">‚è±Ô∏è ${formatTime(src.start_time)} - ${formatTime(src.end_time)}</div>
                <div class="meta-item">‚è≥ Duration: ${src.duration.toFixed(1)}s</div>
              `;
            } else if (src.file_type === 'document') {
              metaInfo = `
                <div class="meta-item">üìë Chunk ${src.chunk_index}</div>
                <div class="meta-item">üìç Chars: ${src.char_start}-${src.char_end}</div>
              `;
            } else if (src.file_type === 'image' && src.ocr_text) {
              metaInfo = `<div class="meta-item">üîç OCR Available</div>`;
            }
            
            return `
              <div class="source-card" id="source-${src.citation_number}">
                <div class="source-header">
                  <span class="citation-badge">[${src.citation_number}]</span>
                  <span class="file-icon">${icon}</span>
                  <span class="source-filename">${src.source_file}</span>
                  <span class="similarity-badge" style="background: ${relevanceColor};">${similarity}% ${relevanceLabel}</span>
                </div>
                <div class="source-content">${src.document}</div>
                <div class="source-meta">
                  <div class="meta-item">üìã Type: ${src.file_type}</div>
                  ${metaInfo}
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                  ${src.file_path ? `<a href="/view_source/${encodeURIComponent(src.file_path)}" target="_blank" class="view-source-btn" style="flex:1;">üëÅÔ∏è View Source File</a>` : ''}
                  ${src.file_path ? `<button onclick="showMetadata('${encodeURIComponent(src.file_path)}')" style="flex:1; font-size:13px; padding:8px;">üìä View Metadata</button>` : ''}
                </div>
              </div>
            `;
          }).join('')
        : '<div class="empty-state">No sources found</div>';
      
      document.getElementById('sources').innerHTML = sourcesHtml;
    }
    
    // Search Mode Switching
    let currentMode = 'text';
    
    function switchMode(mode) {
      currentMode = mode;
      
      // Hide all sections
      document.getElementById('textQuerySection').style.display = 'none';
      document.getElementById('imageQuerySection').style.display = 'none';
      document.getElementById('audioQuerySection').style.display = 'none';
      
      // Reset button styles
      document.getElementById('modeText').style.background = '#95a5a6';
      document.getElementById('modeImage').style.background = '#95a5a6';
      document.getElementById('modeAudio').style.background = '#95a5a6';
      
      // Show selected section and highlight button
      if (mode === 'text') {
        document.getElementById('textQuerySection').style.display = 'block';
        document.getElementById('modeText').style.background = '#667eea';
      } else if (mode === 'image') {
        document.getElementById('imageQuerySection').style.display = 'block';
        document.getElementById('modeImage').style.background = '#667eea';
      } else if (mode === 'audio') {
        document.getElementById('audioQuerySection').style.display = 'block';
        document.getElementById('modeAudio').style.background = '#667eea';
      }
    }
    
    async function askByAudio(){
      const inp = document.getElementById('queryAudio');
      const file = inp.files[0];
      
      // Check if we have recorded audio blob OR file upload
      if (!file && !recordedAudioBlob) {
        alert("Please either:\n‚Ä¢ Upload an audio file, OR\n‚Ä¢ Record your voice using the voice recording button");
        return;
      }
      
      const btn = document.getElementById('askAudioBtn');
      btn.disabled = true;
      
      document.getElementById('resultsContainer').style.display = 'block';
      document.getElementById('answer').innerHTML = '<div class="loading"><div class="spinner"></div>Processing your query and generating answer...</div>';
      document.getElementById('sources').innerHTML = '<div class="loading">Loading sources...</div>';
      
      try {
        const fd = new FormData();
        
        // PRIORITY: If file is uploaded, ALWAYS use file (even if recording exists)
        if (file) {
          // Use uploaded file - needs server transcription
          btn.textContent = '‚è≥ Transcribing uploaded audio...';
          fd.append('query_audio', file);
          fd.append('search_mode', 'audio');
          
          console.log('[Audio] Using uploaded file:', file.name, file.size, 'bytes');
          
        } else if (recordedAudioBlob && currentTranscription.trim()) {
          // ‚úÖ FIX: Use transcribed TEXT instead of audio blob (avoids 500 error!)
          btn.textContent = '‚è≥ Searching with your voice query...';
          fd.append('query', currentTranscription.trim());
          fd.append('search_mode', 'text');
          
          console.log('[Audio] Using transcribed text from voice recording:', currentTranscription.trim());
          
        } else if (recordedAudioBlob) {
          // Fallback: transcription didn't work, send audio blob
          btn.textContent = '‚è≥ Transcribing your voice recording...';
          
          const audioFile = new File([recordedAudioBlob], 'voice_recording.webm', { 
            type: recordedAudioBlob.type 
          });
          
          fd.append('query_audio', audioFile);
          fd.append('search_mode', 'audio');
          
          console.log('[Audio] Using recorded audio blob (fallback):', audioFile.size, 'bytes');
        }
        
        const res = await fetch('/query/', {method:'POST', body: fd});
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('[Audio] Server error response:', errorText);
          throw new Error(`Server returned ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        if (!data) {
          throw new Error('No data received from server');
        }
        
        // Keep transcription display if we used voice recording
        if (currentTranscription.trim()) {
          // Transcription was already shown immediately after recording - keep it visible
          console.log('[Voice] Search completed using pre-transcribed text');
          // Don't update voiceTranscriptText - keep the IMMEDIATE transcription visible
          
          // Clear the variables after successful submission
          recordedAudioBlob = null;
          currentTranscription = '';
          
        } else if (data.transcription) {
          // Server transcribed audio file upload
          console.log('[Voice] Transcription received from server:', data.transcription);
          
          document.getElementById('voiceTranscriptDisplay').style.display = 'block';
          document.getElementById('voiceTranscriptText').innerHTML = `
            <div style="padding: 10px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #27ae60;">
              <strong style="color:#27ae60;">‚úì Transcribed Text:</strong><br>
              <div style="margin-top: 8px; padding: 10px; background: white; border-radius: 3px;">
                <strong style="font-size: 16px; color: #2c3e50;">"${data.transcription}"</strong>
              </div>
              <div style="margin-top: 10px; padding: 8px; background: #d4edda; border-left: 3px solid #28a745; border-radius: 3px;">
                <small style="color:#155724;">
                  <strong>‚úì Success!</strong> Your audio was transcribed and searched successfully.
                </small>
              </div>
            </div>
          `;
        }
        
        displayResults(data);
        
        // Clear file input
        inp.value = '';
        
      } catch(e) {
        console.error("Error during audio query:", e);
        document.getElementById('answer').innerHTML = `<div style="color:#e74c3c;">‚ùå Error: ${e.message}</div>`;
        document.getElementById('sources').innerHTML = '';
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Search by Audio';
      }
    }
    
    // Update the existing askByImage to use new endpoint format
    async function askByImage(){
      const inp = document.getElementById('queryImage');
      const file = inp.files[0];
      if(!file){ 
        alert("Please select an image to query"); 
        return; 
      }
      
      const btn = document.getElementById('askImageBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Processing Image...';
      
      document.getElementById('resultsContainer').style.display = 'block';
      document.getElementById('answer').innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing image and generating answer...</div>';
      document.getElementById('sources').innerHTML = '<div class="loading">Loading sources...</div>';
      
      try {
        const fd = new FormData();
        fd.append('search_mode', 'image');
        fd.append('query_image', file);
        
        const res = await fetch('/query/', {method:'POST', body: fd});
        
        if (!res.ok) {
          throw new Error(`Server returned ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        if (!data) {
          throw new Error('No data received from server');
        }
        
        displayResults(data);
        inp.value = ''; // Clear file input
        
      } catch(e) {
        document.getElementById('answer').innerHTML = `<div style="color:#e74c3c;">‚ùå Error: ${e.message}</div>`;
        document.getElementById('sources').innerHTML = '';
        console.error("Error during image query:", e);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Search by Image';
      }
    }
    
    // Update text query to include search mode
    async function ask(){
      const q = document.getElementById('query').value.trim();
      if(!q){ 
        alert("Please type a question"); 
        return; 
      }
      
      const btn = document.getElementById('askBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Searching & Generating...';
      
      document.getElementById('resultsContainer').style.display = 'block';
      document.getElementById('answer').innerHTML = '<div class="loading"><div class="spinner"></div>Generating answer...</div>';
      document.getElementById('sources').innerHTML = '<div class="loading">Loading sources...</div>';
      
      try {
        const fd = new FormData();
        fd.append('query', q);
        fd.append('search_mode', 'text');
        
        const res = await fetch('/query/', {method:'POST', body: fd});
        
        if (!res.ok) {
          throw new Error(`Server returned ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        if (!data) {
          throw new Error('No data received from server');
        }
        
        displayResults(data);
        
      } catch(e) {
        console.error("Error during query:", e);
        document.getElementById('answer').innerHTML = `<div style="color:#e74c3c;">‚ùå Error: ${e.message}</div>`;
        document.getElementById('sources').innerHTML = '';
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Search & Answer';
      }
    }
    
    // Allow Enter key to submit query (with Shift+Enter for new line)
    document.getElementById('query').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        ask();
      }
    });
    
    // ============================================
    // VOICE RECORDING FUNCTIONALITY (Web Speech API)
    // Shows transcript immediately like VoiceStreamAI
    // Then submits as TEXT query (fast, no server transcription needed)
    // ============================================
    // VOICE RECORDING - MediaRecorder (like VoiceStreamAI)
    // Records actual audio and sends to Faster-Whisper backend
    // ============================================
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let recordedAudioBlob = null;
    let recordingStream = null;
    let recognition = null;  // Speech recognition for live transcription
    let currentTranscription = '';  // Store transcribed text
    
    function toggleVoiceRecording() {
      if (isRecording) {
        stopVoiceRecording();
      } else {
        startVoiceRecording();
      }
    }
    
    async function startVoiceRecording() {
      console.log('[Voice] Starting voice recording with MediaRecorder...');
      
      try {
        // Request microphone access
        console.log('[Voice] Requesting microphone permission...');
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: false
          } 
        });
        
        console.log('[Voice] ‚úì Microphone permission granted!');
        recordingStream = stream;
        
        // Reset previous recording
        audioChunks = [];
        recordedAudioBlob = null;
        
        // Create MediaRecorder
        // Try different formats for browser compatibility
        let options = { mimeType: 'audio/webm' };
        if (!MediaRecorder.isTypeSupported('audio/webm')) {
          console.warn('[Voice] audio/webm not supported, trying audio/mp4');
          options = { mimeType: 'audio/mp4' };
        }
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          console.warn('[Voice] audio/mp4 not supported, using default');
          options = {};
        }
        
        mediaRecorder = new MediaRecorder(stream, options);
        console.log('[Voice] MediaRecorder created with mimeType:', mediaRecorder.mimeType);
        
        // Handle data as it comes in
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
            console.log('[Voice] Audio chunk received:', event.data.size, 'bytes');
          }
        };
        
        // Handle recording stop
        mediaRecorder.onstop = () => {
          console.log('[Voice] Recording stopped, processing audio...');
          
          // Stop speech recognition
          if (recognition) {
            try {
              recognition.stop();
              console.log('[Voice] Speech recognition stopped');
            } catch (e) {
              console.warn('[Voice] Error stopping recognition:', e);
            }
          }
          
          // Create blob from chunks
          recordedAudioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
          console.log('[Voice] ‚úì Audio blob created:', recordedAudioBlob.size, 'bytes');
          
          // Stop all audio tracks
          if (recordingStream) {
            recordingStream.getTracks().forEach(track => {
              track.stop();
              console.log('[Voice] Audio track stopped');
            });
            recordingStream = null;
          }
          
          // Show final transcription IMMEDIATELY (THIS IS WHAT USER WANTED!)
          const finalText = currentTranscription.trim();
          
          if (finalText) {
            // ‚úÖ TRANSCRIPTION SHOWN IMMEDIATELY!
            document.getElementById('voiceStatus').innerHTML = '<span style="color:#27ae60;">‚úì Recording & Transcription Complete!</span>';
            
            document.getElementById('voiceTranscriptDisplay').style.display = 'block';
            document.getElementById('voiceTranscriptText').innerHTML = `
              <div style="padding: 10px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #27ae60;">
                <strong style="color:#27ae60;">‚úì Transcribed Text:</strong><br>
                <div style="margin-top: 8px; font-size: 16px; line-height: 1.5; padding: 10px; background: white; border-radius: 5px; color: #2c3e50;">
                  <strong>"${finalText}"</strong>
                </div>
                <div style="margin-top: 10px; font-size: 13px; color: #666;">
                  <div style="display: flex; gap: 15px; margin-top: 8px;">
                    <span>üìä Size: ${(recordedAudioBlob.size / 1024).toFixed(2)} KB</span>
                    <span>üìù ${finalText.split(' ').length} words</span>
                  </div>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 3px;">
                  <small style="color:#856404;">
                    <strong>üí° Next:</strong> Click <strong>"Search by Audio"</strong> button below to search!
                  </small>
                </div>
              </div>
            `;
            
            console.log('[Voice] ‚úì Transcription shown immediately:', finalText);
          } else {
            // No transcription captured (speech recognition didn't work)
            document.getElementById('voiceStatus').innerHTML = '<span style="color:#f39c12;">‚ö†Ô∏è Recording saved (transcription unavailable)</span>';
            
            document.getElementById('voiceTranscriptDisplay').style.display = 'block';
            document.getElementById('voiceTranscriptText').innerHTML = `
              <div style="padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #f39c12;">
                <strong style="color:#856404;">‚ö†Ô∏è Recording Complete</strong><br>
                <div style="margin-top: 8px;">
                  <p>üìä Size: ${(recordedAudioBlob.size / 1024).toFixed(2)} KB</p>
                  <p style="color:#666; font-size: 14px;">
                    Real-time transcription was unavailable.<br>
                    Audio will be transcribed when you click "Search by Audio".
                  </p>
                </div>
                <div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-left: 3px solid #2196f3; border-radius: 3px;">
                  <small style="color:#0d47a1;">
                    <strong>üí° Next:</strong> Click <strong>"Search by Audio"</strong> button below!
                  </small>
                </div>
              </div>
            `;
          }
        };
        
        // Initialize speech recognition for real-time transcription
        currentTranscription = '';
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.continuous = true;
          recognition.interimResults = true;
          recognition.lang = 'en-US';
          
          recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcript = event.results[i][0].transcript;
              if (event.results[i].isFinal) {
                finalTranscript += transcript + ' ';
              } else {
                interimTranscript += transcript;
              }
            }
            
            if (finalTranscript) {
              currentTranscription += finalTranscript;
            }
            
            // Show real-time transcription
            const displayText = currentTranscription + interimTranscript;
            if (displayText.trim()) {
              document.getElementById('voiceTranscriptText').innerHTML = `
                <div style="padding: 10px; background: #e3f2fd; border-radius: 5px;">
                  <strong style="color:#1976d2;">üé§ Recording... (Real-time transcription)</strong><br>
                  <div style="margin-top: 8px; font-size: 15px; line-height: 1.5; color: #333;">
                    "${displayText}"
                  </div>
                  <small style="color:#666;">Keep speaking... Click "Stop Recording" when done.</small>
                </div>
              `;
            }
          };
          
          recognition.onerror = (event) => {
            console.warn('[Voice] Speech recognition error:', event.error);
            // Don't show error to user - MediaRecorder will still work
          };
          
          try {
            recognition.start();
            console.log('[Voice] ‚úì Speech recognition started for real-time transcription');
          } catch (e) {
            console.warn('[Voice] Could not start speech recognition:', e);
            // Continue anyway - MediaRecorder still works
          }
        }
        
        // Start recording
        mediaRecorder.start();
        isRecording = true;
        console.log('[Voice] ‚úì Recording started!');
        
        // Update UI to recording state
        document.getElementById('voiceRecordBtn').style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
        document.getElementById('voiceRecordBtn').innerHTML = '‚èπÔ∏è Stop Recording';
        document.getElementById('voiceStatus').innerHTML = '<span style="color:#27ae60;">üé§ Recording... Speak now!</span>';
        
        document.getElementById('voiceTranscriptDisplay').style.display = 'block';
        document.getElementById('voiceTranscriptText').innerHTML = `
          <div style="padding: 10px; background: #ffebee; border-radius: 5px; animation: pulse 1.5s ease-in-out infinite;">
            <strong style="color:#e74c3c;">üî¥ Recording in progress...</strong><br>
            <div style="margin-top: 8px; color:#666;">
              Speak your question clearly.<br>
              Click "Stop Recording" when done.
            </div>
          </div>
          <style>
            @keyframes pulse {
              0%, 100% { opacity: 1; }
              50% { opacity: 0.7; }
            }
          </style>
        `;
        
      } catch (error) {
        console.error('[Voice] Error accessing microphone:', error);
        
        let errorMsg = '';
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          errorMsg = '‚ùå Microphone permission denied. Please allow microphone access in your browser.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
          errorMsg = '‚ùå No microphone found. Please connect a microphone and try again.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
          errorMsg = '‚ùå Microphone is already in use by another application.';
        } else {
          errorMsg = `‚ùå Error: ${error.message}`;
        }
        
        document.getElementById('voiceStatus').innerHTML = `<span style="color:#e74c3c;">${errorMsg}</span>`;
        document.getElementById('voiceTranscriptDisplay').style.display = 'block';
        document.getElementById('voiceTranscriptText').innerHTML = `
          <div style="padding: 10px; background: #ffebee; border-radius: 5px; border-left: 3px solid #e74c3c;">
            <strong style="color:#c62828;">‚ùå Cannot Access Microphone</strong><br>
            <div style="margin-top: 8px; color:#c62828;">
              <p><strong>Error:</strong> ${errorMsg}</p>
              <p style="margin-top: 10px;"><strong>Solutions:</strong></p>
              <ul style="margin: 5px 0 5px 20px; font-size: 14px;">
                <li>Click the <strong>microphone icon (üé§)</strong> in your browser's address bar</li>
                <li>Select <strong>"Always allow"</strong> for this site</li>
                <li>Refresh the page (F5) and try again</li>
                <li>Check microphone is connected and working</li>
                <li>Close other apps that might be using the microphone</li>
              </ul>
            </div>
          </div>
        `;
        
        isRecording = false;
        resetVoiceUI();
      }
    }
    
    function stopVoiceRecording() {
      console.log('[Voice] Stopping recording...');
      
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        console.log('[Voice] MediaRecorder.stop() called');
      }
      
      // Stop speech recognition
      if (recognition) {
        try {
          recognition.stop();
          console.log('[Voice] Speech recognition stopped');
        } catch (e) {
          console.warn('[Voice] Error stopping recognition:', e);
        }
      }
      
      isRecording = false;
      
      // UI will be updated in mediaRecorder.onstop
      resetVoiceUI();
    }
    
    function resetVoiceUI() {
      document.getElementById('voiceRecordBtn').style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
      document.getElementById('voiceRecordBtn').innerHTML = 'üé§ Start Voice Recording';
      if (!recordedAudioBlob) {
        document.getElementById('voiceStatus').innerHTML = '<span style="color:#7f8c8d;">Status: Ready</span>';
      }
    }
    
    // ============================================
    // FILE UPLOAD LISTENER - Clear voice recording when file selected
    // ============================================
    document.getElementById('queryAudio').addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        const fileName = e.target.files[0].name;
        const fileSize = (e.target.files[0].size / 1024).toFixed(2);
        
        // Clear voice recording since user chose to upload file instead
        recordedAudioBlob = null;
        
        // Hide voice transcript display and show file info
        document.getElementById('voiceTranscriptDisplay').style.display = 'block';
        document.getElementById('voiceTranscriptText').innerHTML = `
          <div style="padding: 10px; background: #e8f5e9; border-radius: 5px;">
            <strong style="color:#27ae60;">‚úì Audio File Selected:</strong><br>
            <div style="margin-top: 8px;">
              üìÅ <strong>${fileName}</strong><br>
              <small>Size: ${fileSize} KB</small><br>
              <small style="color:#7f8c8d;">Click "Search by Audio" to transcribe and search</small>
            </div>
          </div>
        `;
        
        // Update status
        document.getElementById('voiceStatus').innerHTML = '<span style="color:#27ae60;">‚úì File ready for upload</span>';
        
        console.log('File selected:', fileName, fileSize, 'KB');
      } else {
        // File was deselected
        document.getElementById('voiceTranscriptDisplay').style.display = 'none';
        document.getElementById('voiceStatus').textContent = 'Status: Ready';
        document.getElementById('voiceStatus').style.color = '#7f8c8d';
      }
    });
    
    // ============================================
    // CITATION NAVIGATION
    // ============================================
    function scrollToSource(citationNumber) {
      const sourceCard = document.getElementById(`source-${citationNumber}`);
      if (sourceCard) {
        sourceCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        sourceCard.style.animation = 'highlight-pulse 1.5s';
        setTimeout(() => {
          sourceCard.style.animation = '';
        }, 1500);
      }
    }
    
    // ============================================
    // METADATA VIEWER
    // ============================================
    async function showMetadata(encodedPath) {
      try {
        const res = await fetch(`/source_metadata/${encodedPath}`);
        const metadata = await res.json();
        
        if (metadata.error) {
          alert('Error loading metadata: ' + metadata.error);
          return;
        }
        
        let metadataHtml = `
          <div style="background: white; padding: 20px; border-radius: 10px; max-width: 600px; margin: 20px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #2c3e50;">üìä File Metadata</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 8px; font-weight: 600; color: #7f8c8d;">File Name:</td>
                <td style="padding: 8px;">${metadata.file_name}</td>
              </tr>
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 8px; font-weight: 600; color: #7f8c8d;">File Size:</td>
                <td style="padding: 8px;">${metadata.file_size_formatted}</td>
              </tr>
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 8px; font-weight: 600; color: #7f8c8d;">Type:</td>
                <td style="padding: 8px;">${metadata.type || 'unknown'} (${metadata.extension})</td>
              </tr>
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 8px; font-weight: 600; color: #7f8c8d;">Modified:</td>
                <td style="padding: 8px;">${metadata.modified_date}</td>
              </tr>
        `;
        
        if (metadata.dimensions) {
          metadataHtml += `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 8px; font-weight: 600; color: #7f8c8d;">Dimensions:</td>
              <td style="padding: 8px;">${metadata.dimensions}</td>
            </tr>
          `;
        }
        
        if (metadata.duration) {
          metadataHtml += `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 8px; font-weight: 600; color: #7f8c8d;">Duration:</td>
              <td style="padding: 8px;">${metadata.duration}</td>
            </tr>
          `;
        }
        
        if (metadata.chunk_count) {
          metadataHtml += `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 8px; font-weight: 600; color: #7f8c8d;">Indexed Chunks:</td>
              <td style="padding: 8px;">${metadata.chunk_count}</td>
            </tr>
          `;
        }
        
        if (metadata.avg_ocr_confidence) {
          metadataHtml += `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 8px; font-weight: 600; color: #7f8c8d;">OCR Confidence:</td>
              <td style="padding: 8px;">${metadata.avg_ocr_confidence}</td>
            </tr>
          `;
        }
        
        metadataHtml += `
            </table>
            <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 15px; width: 100%;">Close</button>
          </div>
        `;
        
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto;';
        overlay.innerHTML = metadataHtml;
        overlay.onclick = (e) => {
          if (e.target === overlay) overlay.remove();
        };
        document.body.appendChild(overlay);
        
      } catch(e) {
        console.error('Error fetching metadata:', e);
        alert('Error loading metadata: ' + e.message);
      }
    }
    
    // Add CSS for citation links
    const style = document.createElement('style');
    style.textContent = `
      .citation-link {
        color: #3498db;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.2s;
      }
      .citation-link:hover {
        background: #3498db;
        color: white;
        text-decoration: none;
      }
      @keyframes highlight-pulse {
        0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        50% { box-shadow: 0 0 25px rgba(52, 152, 219, 0.6); border-color: #3498db; }
      }
    `;
    document.head.appendChild(style);
    
    // Check MediaRecorder support on page load
    window.addEventListener('DOMContentLoaded', function() {
      console.log('[Voice] Page loaded, checking MediaRecorder support...');
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.warn('[Voice] MediaRecorder API not supported');
        document.getElementById('voiceStatus').innerHTML = '<span style="color:#e74c3c;">‚ö†Ô∏è Voice recording not supported in this browser.</span>';
        document.getElementById('voiceRecordBtn').disabled = true;
        document.getElementById('voiceRecordBtn').title = 'Voice recording not supported in this browser';
      } else {
        console.log('[Voice] ‚úì MediaRecorder API is supported!');
        document.getElementById('voiceStatus').innerHTML = '<span style="color:#27ae60;">‚úì Voice recording ready</span>';
      }
    });
    
  </script>
</body>
</html>
